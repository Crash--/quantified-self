<mat-card class="mat-elevation-z0">

  <app-shade [isActive]="isLoading" [hasError]="errorLoading" [errorMessage]="errorLoading"></app-shade>
  <app-shade [isActive]="false" [hasError]="(!this.events || !this.events.length) && !isLoading" [errorMessage]="'Nothing to show'"></app-shade>

  <!-- hide the below for now till proper DB filtering is live -->
  <!--<mat-form-field>-->
  <!--<input matInput (keyup)="applyFilter($event.target.value)" placeholder="Filter">-->
  <!--</mat-form-field>-->
  <table mat-table [dataSource]="data" matSort multiTemplateDataRows>
    <ng-container *ngFor="let column of getColumnsToDisplayDependingOnScreenSize(); first as isFirst; last as isLast; index as i;" [matColumnDef]="column">
      <ng-container *ngIf="isFirst && hasActions">
        <th mat-header-cell *matHeaderCellDef>
          <mat-icon *ngIf="!expandAll" (click)="expandAll = true;">unfold_more</mat-icon>
          <mat-icon *ngIf="expandAll" (click)="expandAll = false;">unfold_less</mat-icon>
        </th>
      </ng-container>
      <ng-container *ngIf="i===1 && hasActions">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
      </ng-container>
      <ng-container *ngIf="isLast && hasActions">
        <th mat-header-cell *matHeaderCellDef>
        </th>
      </ng-container>
      <ng-container *ngIf="(!isFirst && !isLast) || !hasActions">

        <ng-container *ngIf="isColumnHeaderSortable(column)">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
             <mat-icon *ngIf="getColumnHeaderIcon(column)">{{ getColumnHeaderIcon(column) }}</mat-icon>
            <mat-icon *ngIf="getColumnHeaderSVGIcon(column)" svgIcon="{{ getColumnHeaderSVGIcon(column) }}"></mat-icon>
          </th>
        </ng-container>

        <ng-container *ngIf="!isColumnHeaderSortable(column)">
          <th mat-header-cell *matHeaderCellDef >
            <mat-icon *ngIf="getColumnHeaderIcon(column)">{{ getColumnHeaderIcon(column) }}</mat-icon>
            <mat-icon *ngIf="getColumnHeaderSVGIcon(column)" svgIcon="{{ getColumnHeaderSVGIcon(column) }}"></mat-icon>
          </th>
        </ng-container>

      </ng-container>
      <td mat-cell *matCellDef="let row">
        <mat-icon *ngIf="column === 'expand' && !expandAll && expandedElement !== row" (click)="$event.stopPropagation(); expandedElement = expandedElement === row ? null : row">
          chevron_right
        </mat-icon>
        <mat-icon *ngIf="column === 'expand' && (expandAll || expandedElement === row)" (click)="$event.stopPropagation(); expandAll = false; expandedElement = expandedElement === row ? null : row">
          expand_more
        </mat-icon>
        <mat-checkbox *ngIf="column === 'checkbox'" (click)="$event.stopPropagation()"
                      (change)="$event ? checkBoxClick(row) : null"
                      [checked]="selection.isSelected(row)">
        </mat-checkbox>
        <span *ngIf="column === 'actions'">
          <app-event-actions *ngIf="user" [user]="user" [event]="row.event"></app-event-actions>
        </span>
        <span *ngIf="column === 'stats.Activity Types'">
          <span *ngIf="row['isMerge']"><mat-icon>compare_arrows</mat-icon></span>
          {{ row[column] }}
        </span>
        <span *ngIf="column !== 'checkbox' && column !== 'actions' && column !== 'stats.Activity Types' && column!=='privacy'">
          {{ row[column] }}
        </span>
      </td>
    </ng-container>

    <ng-container [matColumnDef]="'expandedDetail'">
      <td mat-cell *matCellDef="let element" [attr.colspan]="getColumnsToDisplayDependingOnScreenSize().length">
        <div class="detail"
             [@detailExpand]="element == expandedElement || expandAll ? 'expanded' : 'collapsed'">
        <table style="text-align: left">
          <tr>
            <td>
              <app-privacy-icon [privacy]="element.privacy"></app-privacy-icon>
            </td>
            <td>
              <app-edit-input
                *ngIf="hasActions"
                [(data)]='element.name'
                [type]="'text'"
                [placeHolder]="'Name'"
                (dataChange)="saveEventName(element.name, element.event)">
              </app-edit-input>
            </td>
            <td>
              <app-edit-input
                *ngIf="hasActions"
                [(data)]='element.description'
                [type]="'textArea'"
                [placeHolder]="'Add a description'"
                (dataChange)="saveEventDescription(element.description, element.event)">
              </app-edit-input>
            </td>
          </tr>
          <tr>
            <td>

            </td>
            <td>
              <app-edit-input
                *ngIf="hasActions && element.feeling !== undefined"
                [(data)]='element.feeling'
                [type]="'select'"
                [placeHolder]="'Feeling'"
                [selectOptions]="getEnumKeyValue(feelings)"
                (dataChange)="saveEventFeeling(element.feeling, element.event)">
              </app-edit-input>
            </td>
            <td>
              <app-edit-input
                *ngIf="hasActions"
                [(data)]='element.rpe'
                [type]="'select'"
                [placeHolder]="'Rating of Perceived Exertion'"
                [selectOptions]="getEnumKeyValue(rpeBorgCR10SCale)"
                (dataChange)="saveEventRPE(element.rpe, element.event)">
              </app-edit-input>
            </td>
          </tr>
        </table>
        </div>
      </td>
    </ng-container>


    <tr mat-header-row *matHeaderRowDef="getColumnsToDisplayDependingOnScreenSize()"></tr>
    <tr mat-row *matRowDef="let row; columns: getColumnsToDisplayDependingOnScreenSize();" [@rowsAnimation]=""
            [routerLink]="['/user', user.uid, 'event', row.event.getID()]"
            [class.merged]="row['isMerge']"
            [class.expanded-row]="expandedElement === row || expandAll"
            class="normal-row">
    </tr>
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
  </table>
  <mat-paginator [hidePageSize]="true" [length]="resultsLength" [pageSize]="eventsPerPage"></mat-paginator>
</mat-card>
