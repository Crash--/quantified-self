<mat-card>

  <!-- The lines and points -->
  <agm-map
    [fullscreenControl]="true"
    [mapTypeControl]="true"
    [scaleControl]="true">
    <agm-polyline
      *ngFor="let data of mapData"
      [strokeColor]="eventColorService.getActivityColor(event, data.activity)"
      [strokeWeight]="4">
      <agm-polyline-point
        *ngFor="let point of data.activityPoints"
        [latitude]="point.getPosition().latitudeDegrees"
        [longitude]="point.getPosition().longitudeDegrees">
      </agm-polyline-point>
    </agm-polyline>

    <!-- Laps and infowindows -->

    <ng-container *ngFor="let activityData of mapData">
      <agm-marker (markerClick)="openActivityStartMarkerInfoWindow(activityData.activity)"
                  [iconUrl]="'https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=home|'+ eventColorService.getActivityColor(event, activityData.activity).slice(1)"
                  [latitude]="activityData.activityStartPoint.getPosition().latitudeDegrees"
                  [longitude]="activityData.activityStartPoint.getPosition().longitudeDegrees">
        <agm-info-window
          [isOpen]="openedActivityStartMarkerInfoWindow === activityData.activity"
          [disableAutoPan]="false"
          [latitude]="activityData.activityStartPoint.getPosition().latitudeDegrees"
          [longitude]="activityData.activityStartPoint.getPosition().longitudeDegrees">
          <span class="mat-title">Start {{activityData.activity.startDate.toLocaleTimeString()}}</span>
          <mat-divider [inset]="true"></mat-divider>
          <span class="mat-subheading-1">End {{activityData.activity.endDate.toLocaleTimeString()}}</span>
          <mat-divider [inset]="true"></mat-divider>
          <span class="mat-subheading-1">Duration: {{ activityData.activity.getDuration().getDisplayValue() }}{{ activityData.activity.getDuration().getDisplayUnit() }}</span>
          <mat-divider [inset]="true"></mat-divider>
          <span class="mat-subheading-1">Distance: {{ activityData.activity.getDistance().getDisplayValue() }}{{ activityData.activity.getDistance().getDisplayUnit() }}</span>
        </agm-info-window>
      </agm-marker>

      <agm-marker
        *ngFor="let lapData of activityData.lapsWithPosition; let i = index; last as isLast"
        (markerClick)="openLapMarkerInfoWindow(lapData.lap)"
        [iconUrl]="'https://chart.googleapis.com/chart?chst=' + ( isLast ? 'd_map_pin_icon&chld=flag|' : 'd_map_pin_letter&chld=' + (i+1) + '|') + eventColorService.getActivityColor(event, activityData.activity).slice(1)"
        [latitude]="lapData.lapEndPoint.getPosition().latitudeDegrees"
        [longitude]="lapData.lapEndPoint.getPosition().longitudeDegrees">
        <agm-info-window
          [disableAutoPan]="false"
          [isOpen]="openedLapMarkerInfoWindow === lapData.lap"
          [latitude]="lapData.lapEndPoint.getPosition().latitudeDegrees"
          [longitude]="lapData.lapEndPoint.getPosition().latitudeDegrees">
          <app-activity-header [event]="event" [activity]="activityData.activity" [showType]="false"
                               [showDuration]="false"></app-activity-header>
          <span class="mat-title">Lap {{ i +1 }}</span>
          <mat-divider [inset]="true"></mat-divider>
          <span class="mat-subheading-1">Duration: {{ lapData.lap.getDuration().getDisplayValue() }}{{ lapData.lap.getDuration().getDisplayUnit() }}</span>
          <mat-divider [inset]="true"></mat-divider>
          <span class="mat-subheading-1">Distance: {{ lapData.lap.getDistance().getDisplayValue() }}{{ lapData.lap.getDistance().getDisplayUnit() }}</span>
          <ng-container *ngIf="lapData.lapEndPoint.getDataByType('Altitude')">
            <mat-divider [inset]="true"></mat-divider>
            <span class="mat-subheading-1">Altitude: {{ lapData.lapEndPoint.getDataByType('Altitude').getDisplayValue() }}{{ lapData.lapEndPoint.getDataByType('Altitude').getDisplayUnit() }}</span>
          </ng-container>
          <ng-container *ngIf="lapData.lap.getStat('DataHeartRateAvg')">
            <mat-divider [inset]="true"></mat-divider>
            <span class="mat-subheading-1">Avg HR: {{ lapData.lap.getStat('DataHeartRateAvg').getDisplayValue() }}{{ lapData.lap.getStat('DataHeartRateAvg').getDisplayUnit() }}</span>
          </ng-container>
          <ng-container *ngIf="lapData.lap.getStat('DataAscent')">
            <mat-divider [inset]="true"></mat-divider>
            <span class="mat-subheading-1">Ascent: {{ lapData.lap.getStat('DataAscent').getDisplayValue() }}{{ lapData.lap.getStat('DataAscent').getDisplayUnit() }}</span>
          </ng-container>
          <ng-container *ngIf="lapData.lap.getStat('DataSpeedAvg')">
            <mat-divider [inset]="true"></mat-divider>
            <span
              class="mat-subheading-1">Speed: {{((lapData.lap.getStat('DataSpeedAvg').getValue()*3600)/1000).toFixed(1) }}km/h</span>
          </ng-container>
          <ng-container *ngIf="lapData.lap.getStat('DataSpeedAvg')">
            <mat-divider [inset]="true"></mat-divider>
            <span class="mat-subheading-1">Pace: {{ (1000/lapData.lap.getStat('DataSpeedAvg').getValue()) * 1000 | date:'mm:ss' }}m/km</span>
          </ng-container>
          <ng-container *ngIf="lapData.lap.getStat('DataVerticalSpeedAvg')">
            <mat-divider [inset]="true"></mat-divider>
            <span class="mat-subheading-1">Vertical Speed: {{(lapData.lap.getStat('DataVerticalSpeedAvg').getValue()*60).toFixed(3) }}{{ lapData.lap.getStat('DataVerticalSpeedAvg').getDisplayUnit() }}</span>
          </ng-container>
        </agm-info-window>
      </agm-marker>

    </ng-container>
  </agm-map>
</mat-card>
